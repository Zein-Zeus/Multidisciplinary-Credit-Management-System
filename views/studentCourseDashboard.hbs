<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="/css/studentCourseDashboard.css"> <!-- Make sure the path is correct -->
</head>

<body>

    <div class="container">
        <nav>
            <div class="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="Logo">
                </a>
            </div>
            <ul>
                <li><a href="/home">Home</a></li>
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/course">Courses</a></li>
            </ul>
            <div class="user-profile">
                <div class="user-initials">{{userInitials}}</div>
            </div>
        </nav>

        <main>

            <div class="course-header">
                <img class="course-image" src="{{course.image}}" alt="Course Image" />
                <div class="course-info">
                    <h1 id="course_name">{{course.courseName}}</h1>
                    <h2 id="college_name">{{course.collegeName}}</h2>
                    <p>Mode: {{course.mode}} | Credits: {{course.credits}} | Duration: {{course.duration}}</p>
                </div>
            </div>

            <div class="course-nav">
                <ul>
                    <li><a href="#about">About</a></li>
                    <li><a href="#modules">Modules</a></li>
                    <li><a href="#studyM">Study Material</a></li>
                    <li><a href="#assignment">Assignment</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>

            <div class="course-section">
                <h3 id="about">About</h3>
                <p>{{course.courseDescription}}</p>

                <h3 id="modules">Modules</h3>
                <p>{{course.courseModules}}</p>

                <h3 id="studyM">Study Material</h3>
                <p>{{#if course.studyMaterial}}Uploaded{{else}}Not Uploaded Yet{{/if}}</p>

                <h3 id="assignment">Assignments</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Topic</th>
                            <th>Description</th>
                            <th>Max. Marks</th>
                            <th>Posted</th>
                            <th>Due</th>
                            <th>File</th>
                            <th>Upload</th>
                            <th>View</th>
                            <th>Action</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each assignmentDetails}}
                        <tr>
                            <td>{{name}}</td>
                            <td>{{topic}}</td>
                            <td>{{description}}</td>
                            <td>{{marks}}</td>
                            <td>{{posted}}</td>
                            <td>{{due}}</td>
                            <td>
                                <input type="file" id="fileInput-{{@index}}" style="display: none;" />
                            </td>
                            <td>
                                <button id="uploadBtn-{{@index}}" onclick="openFileManager({{@index}})">Upload</button>
                            </td>
                            <td>
                                <button onclick="viewFile({{@index}})">View</button>
                            </td>
                            <td>
                                <button onclick="submitAssignment({{@index}})">Submit</button>
                            </td>
                            <td class="status {{statusClass}}">{{status}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>


                <h3 id="contact">Contact</h3>
                <p>Faculty: {{course.facultyName}}</p>
            </div>


        </main>

    </div>
    
    {{!-- <footer>
        <div class="footer-info">
            <p>Address: 1, Nathibai Thackersey Road, Mumbai 400020</p>
            <p>Contact Information:</p>
            <p>Website: <a href="https://sndt.ac.in/">https://sndt.ac.in/</a></p>
            <p>Phone: 022-2203 1879 | 022-2203 2159</p>
        </div>
    </footer> --}}

    <script>
        const uploadedFiles = [];

        function openFileManager(index) {
            const fileInput = document.getElementById(`fileInput-${index}`);
            if (!uploadedFiles[index]) {
                fileInput.click();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fileInputs = document.querySelectorAll("input[type='file']");
            fileInputs.forEach((input, index) => {
                input.addEventListener("change", (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const allowedTypes = ['application/pdf'];
                        if (!allowedTypes.includes(file.type)) {
                            alert("File format not supported. Only PDF files can be uploaded.");
                            input.value = "";
                            return;
                        }

                        uploadedFiles[index] = file;
                        alert(`File "${file.name}" uploaded for assignment ${index + 1}`);

                        const uploadBtn = document.getElementById(`uploadBtn-${index}`);
                        const cell = uploadBtn.parentElement;
                        cell.innerHTML = `<span class="file-name">${file.name}</span>`;
                    }
                });
            });
        });

        function viewFile(index) {
            const file = uploadedFiles[index];
            if (file) {
                const fileURL = URL.createObjectURL(file);

                const previewTypes = ['application/pdf'];
                if (previewTypes.includes(file.type)) {
                    // Open a new popup window with minimal features
                    const popup = window.open("", "_blank", "width=800,height=600,scrollbars=yes,resizable=yes");
                    popup.document.write(`
                <html>
                    <head>
                        <title>View File - ${file.name}</title>
                    </head>
                    <body style="margin:0">
                        <embed src="${fileURL}" type="${file.type}" width="100%" height="100%" />
                    </body>
                </html>
            `);
                    popup.document.close();
                } else {
                    alert("Preview not supported for this file type.");
                }
            } else {
                alert("No file uploaded yet for this assignment.");
            }
        }

        function closeModal() {
            document.getElementById('fileModal').style.display = 'none';
            document.getElementById('fileViewer').src = '';
        }

        function submitAssignment(index) {
            const fileInput = document.getElementById(`fileInput-${index}`);
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a file first by clicking Upload.");
                return;
            }

            const formData = new FormData();
            formData.append('assignmentFile', file);

            fetch('/student-upload-assignment', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(err => {
                    console.error("Submit error:", err);
                    alert("Something went wrong.");
                });
        }
    </script>
</body>

</html>